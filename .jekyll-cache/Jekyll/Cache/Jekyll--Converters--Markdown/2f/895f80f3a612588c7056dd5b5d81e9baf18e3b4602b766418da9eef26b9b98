I"˙2<h1 id="introduction">Introduction</h1>

<p>At my company we are using Workplace by Facebook for all of it‚Äôs possibilities and functionalities and it‚Äôs really useful for sharing information around whole organization. We have a lot of different Workplace groups with different type of content. One of those groups is related to technology and coding where we decided to share and create a post in Workplace on some action or change in one of ours Github repositories. For example get notifications on merges to the master branch and releases in Github and create a Workplace post with all necessary information. Then I thought this integration should be fairly simple and I just need a place to run my code. And that‚Äôs where the Azure Functions came into place.</p>

<p>In this post I will try to show the easiest way to integrate these two systems and share my code and findings in one place. So, don‚Äôt expect anything fancy because this is still work in progress and it will definitely grow in functionality. As an easy example I decided to use Github trigger on creation of a new issue in the Repo. That being said first thing I had to do is to create a function which I need to expose and use the Azure function URL to create a webhook in the desired Github repository. I used C# for development of the integration.</p>

<p><em>If you are just starting with Azure Functions with Java and you came upon this blog post this what I have followed and installed and eventually used and tested successfully the quickstart of: *
*<a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-java-maven">Use Java and Maven to create and publish a function to Azure.</a>‚Äù</em></p>

<p><em>Then if you want to use C# then you need the latest version of the <a href="https://visualstudio.microsoft.com/vs/">Visual Studio 2019</a> form which you have all the support needed to develop and deploy in Azure Functions and much more.</em></p>

<p>Ok lets start with the code of the Azure function written in C# then a setup of the Github webhook and setup of the Workplace Bot</p>

<h1 id="1-azure-function-code">1. Azure Function code</h1>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">GithubWorkplaceAzure</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">GithubWebhookWorkplaceFunction</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="nf">FunctionName</span><span class="p">(</span><span class="s">"GithubWebhookWorkplaceFunction"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">HttpResponseMessage</span><span class="p">&gt;</span> <span class="nf">Run</span><span class="p">([</span><span class="nf">HttpTrigger</span><span class="p">(</span><span class="n">AuthorizationLevel</span><span class="p">.</span><span class="n">Function</span><span class="p">,</span> <span class="s">"get"</span><span class="p">,</span> <span class="s">"post"</span><span class="p">,</span> <span class="n">Route</span> <span class="p">=</span> <span class="k">null</span><span class="p">)]</span><span class="n">HttpRequestMessage</span> <span class="n">req</span><span class="p">,</span> <span class="n">ILogger</span> <span class="n">log</span><span class="p">)</span>
        <span class="p">{</span>          
            <span class="c1">// Get request body</span>
            <span class="kt">dynamic</span> <span class="n">data</span> <span class="p">=</span> <span class="k">await</span> <span class="n">req</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="n">ReadAsAsync</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;();</span>

            <span class="c1">// Extract github data from request</span>
            <span class="kt">string</span> <span class="n">repoName</span> <span class="p">=</span> <span class="n">data</span><span class="p">?.</span><span class="n">repository</span><span class="p">?.</span><span class="n">name</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">repoDescription</span> <span class="p">=</span> <span class="n">data</span><span class="p">?.</span><span class="n">repository</span><span class="p">?.</span><span class="n">description</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">gitHubIssue</span> <span class="p">=</span> <span class="n">data</span><span class="p">?.</span><span class="n">issue</span><span class="p">?.</span><span class="n">title</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">issueDescription</span> <span class="p">=</span> <span class="n">data</span><span class="p">?.</span><span class="n">issue</span><span class="p">?.</span><span class="n">body</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">gitSender</span> <span class="p">=</span> <span class="n">data</span><span class="p">?.</span><span class="n">sender</span><span class="p">?.</span><span class="n">login</span><span class="p">;</span>            
            <span class="kt">string</span> <span class="n">issueURL</span> <span class="p">=</span> <span class="n">data</span><span class="p">?.</span><span class="n">issue</span><span class="p">?.</span><span class="n">html_url</span><span class="p">;</span>


            <span class="c1">//Creating a new issue post content for Workplace</span>
            <span class="kt">string</span> <span class="n">message</span> <span class="p">=</span> <span class="s">"New issue in repo: "</span> <span class="p">+</span> <span class="n">repoName</span> <span class="p">+</span> <span class="s">"\n"</span> <span class="p">+</span>
                             <span class="s">"Repo description: "</span> <span class="p">+</span> <span class="n">repoDescription</span> <span class="p">+</span> <span class="s">"\n"</span> <span class="p">+</span>
                             <span class="s">"\n"</span> <span class="p">+</span>
                             <span class="s">"Issue: "</span> <span class="p">+</span> <span class="n">gitHubIssue</span> <span class="p">+</span> <span class="s">"\n"</span> <span class="p">+</span>
                             <span class="s">"Comment: "</span> <span class="p">+</span> <span class="n">issueDescription</span> <span class="p">+</span> <span class="s">"\n"</span> <span class="p">+</span> <span class="s">"\n"</span> <span class="p">+</span>
                             <span class="s">"\n"</span> <span class="p">+</span>
                             <span class="s">"Sender: "</span> <span class="p">+</span> <span class="n">gitSender</span> <span class="p">+</span> <span class="s">"\n"</span> <span class="p">+</span>
                             <span class="s">"Issue url: "</span> <span class="p">+</span> <span class="n">issueURL</span><span class="p">;</span>

			<span class="c1">//Posting created message to the Workplace</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">())</span>
            <span class="p">{</span>

                <span class="n">httpClient</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">"https://graph.facebook.com/"</span><span class="p">);</span>

                <span class="kt">var</span> <span class="n">parametters</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="p">{</span> <span class="s">"access_token"</span><span class="p">,</span> <span class="s">"[YOUR WORKPALCE TOKEN VALUE]"</span> <span class="p">},</span>
                    <span class="p">{</span> <span class="s">"message"</span><span class="p">,</span> <span class="n">message</span> <span class="p">}</span>
                <span class="p">};</span>                

                <span class="kt">var</span> <span class="n">encodedContent</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FormUrlEncodedContent</span><span class="p">(</span><span class="n">parametters</span><span class="p">);</span>
                <span class="kt">string</span> <span class="n">groupId</span> <span class="p">=</span> <span class="s">"[YOUR WORKPLACE GROUPID]"</span><span class="p">;</span>

                <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">httpClient</span><span class="p">.</span><span class="nf">PostAsync</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">groupId</span><span class="p">}</span><span class="s">/feed"</span><span class="p">,</span> <span class="n">encodedContent</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">responseStr</span> <span class="p">=</span> <span class="k">await</span> <span class="n">result</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">();</span>                
                <span class="kt">var</span> <span class="n">msg</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="nf">EnsureSuccessStatusCode</span><span class="p">();</span>
                <span class="k">return</span> <span class="n">req</span><span class="p">.</span><span class="nf">CreateResponse</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="p">,</span> <span class="s">"Response Workplace: "</span> <span class="p">+</span> <span class="n">msg</span><span class="p">);</span>
            <span class="p">}</span>
            
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="2-github-webhook">2. Github webhook</h1>

<p>It‚Äôs fairly simple to create a Github webhook, choose your desired repository and create a trigger on which actions you want the Azure function to be called. In my case I created a github webhook when a new issue is created. This is how it looks in my repo:</p>

<p><img src="/images/2020-02-12-Github-integration-with-Workplace-by-Facebook-via-Azure-Functions/GithubWebhookSetup_1.jpg" alt="" /></p>

<p><img src="/images/2020-02-12-Github-integration-with-Workplace-by-Facebook-via-Azure-Functions/GithubWebhookSetup_2.jpg" alt="" /></p>

<p>I haven‚Äôt created a secret key in the Azure functions yet, but that is one of my next steps. This was a quick PoC where I wanted to test posability of the integration between Github and Workplace by Facebook.</p>

<h1 id="3-workplace-setup">3. Workplace setup</h1>

<p>I will not go into too much detail here only to explain which info we need from the Workplace bot so we could actually post the content on the desired Workplace group. This is also related if you are using Facebook groups, fun pages or just your Facebook wall.</p>

<ol>
  <li>First thing you will need is your Group ID. This you can find directly from the link of the group itself. In the code replace the text: ‚Äú[YOUR WORKPLACE GROUPID]‚Äù with your actual GrouId value.</li>
  <li>Next is to retrieve the Token value of the Workplace/Facebook bot. In the code replace the text ‚Äú[YOUR WORKPALCE TOKEN VALUE]‚Äù with the actual token value.</li>
  <li>And don‚Äôt forget that Workplace and Facebook are using the Graph API for all the third party communication and integration via link: <a href="https://graph.facebook.com/">https://graph.facebook.com/</a></li>
</ol>

<p>More about the Facbook bots you can read here <a href="https://developers.facebook.com/docs/workplace/bots">https://developers.facebook.com/docs/workplace/bots</a></p>

<h1 id="4-testing-the-integration">4. Testing the integration</h1>

<p>As a simple test here let‚Äôs create an issue in our repo:</p>

<p><img src="/images/2020-02-12-Github-integration-with-Workplace-by-Facebook-via-Azure-Functions/GithubIssue.jpg" alt="" /></p>

<p>As soon as we post the issue we can check the workplace group wall for the new Github issue post.</p>

<p><img src="/images/2020-02-12-Github-integration-with-Workplace-by-Facebook-via-Azure-Functions/WorkplacePostInGroup.jpg" alt="" /></p>
:ET