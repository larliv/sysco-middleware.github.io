I"ߦ<h1 id="testing-kafka-based-applications">Testing Kafka-based applications</h1>
<p><img src="/images/2019-06-24-testing-kafka-based-applications/streams.jpg" alt="streams" /></p>

<blockquote>
  <p>Github: <a href="https://github.com/sysco-middleware/kafka-testing">https://github.com/sysco-middleware/kafka-testing</a></p>
</blockquote>

<p>This blog is of continuation of discussion in these posts:</p>
<ol>
  <li><a href="https://www.confluent.io/blog/stream-processing-part-2-testing-your-streaming-application">Getting Your Feet Wet with Stream Processing - Part 2: Testing Your Streaming Application</a></li>
  <li><a href="https://www.confluent.io/blog/testing-event-driven-systems">Testing Event-Driven Systems</a></li>
</ol>

<p>Main purpose of this article is to share experience of testing Apache Kafka-based applications and data pipelines, using two different approaches.</p>

<p>Keywords in use:</p>
<ul>
  <li><strong>Kafka-based application</strong> - by kafka-based application I understand any application that uses <code class="highlighter-rouge">Kafka API</code> and communicates with kafka cluster.</li>
  <li><strong>Data pipeline</strong> - is a set of Kafka-based applications that are connected into a single context.</li>
</ul>

<p>Examples are built using java and docker. For detailed information, check this repository on <a href="https://github.com/sysco-middleware/kafka-testing">github</a>.</p>

<h2 id="agenda">Agenda</h2>
<ol>
  <li>Intro</li>
  <li>Unit tests of Kafka Streams application with <a href="https://kafka.apache.org/documentation/streams/developer-guide/testing.html">kafka-streams-test-utils</a></li>
  <li>Integration tests with <a href="https://github.com/apache/kafka/tree/trunk/streams/src/test/java/org/apache/kafka/streams/integration/utils">EmbeddedKafkaCluster</a></li>
  <li>End-to-end tests with <a href="https://www.testcontainers.org">Testcontainers</a></li>
</ol>

<h3 id="1-intro">1. Intro</h3>
<p>Many have faced a challenge to test applications that communicate with Kafka cluster. The common issues are how to write unit tests, how to automate tests for Kafka application in isolation and how to handle end-to-end and system tests for whole data pipeline.</p>

<p>When this article was written, there were several approaches, some of them still not resolved:</p>
<ol>
  <li><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-139%3A+Kafka+TestKit+library">KIP-139: Kafka TestKit library</a> is still open. Once it will be ready, the Kafka community will have a proper test-kit.</li>
  <li><a href="https://github.com/confluentinc/kafka-streams-examples/issues/26">#26 Encapsulate EmbeddedSingleNodeKafkaCluster in a seperately-available maven/gradle/sbt</a> dep. Kafka cluster in memory. When this post was published, there is an open issue for having release of embedded Kafka cluster. <a href="https://www.confluent.io/blog/author/yeva-byzek/">Yeva Byzek</a> offers 
to use <a href="https://github.com/apache/kafka/tree/trunk/streams/src/test/java/org/apache/kafka/streams/integration/utils">KafkaEmbeddedCluster</a> in this <a href="https://www.confluent.io/blog/stream-processing-part-2-testing-your-streaming-application">blog-post</a>. There is no existing release for these libraries. I decided to duplicate this part of code base and to build an <a href="https://github.com/sysco-middleware/kafka-testing/tree/master/embedded-cluster">internal module</a> as an example.</li>
  <li><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-247%3A+Add+public+test+utils+for+Kafka+Streams">KIP-247 Add public test utils for Kafka Streams</a>. This KIP is ready and has release for unit testing kafka streams topologies - <a href="https://kafka.apache.org/20/documentation/streams/developer-guide/testing.html">kafka-streams-test-utils</a>.</li>
  <li><a href="https://www.testcontainers.org">Testcontainers</a> - testing with docker containers.</li>
</ol>

<h3 id="2-unit-tests-of-kafka-streams-application-with-kafka-streams-test-utils">2. Unit tests of Kafka Streams application with kafka-streams-test-utils</h3>
<p><a href="https://kafka.apache.org/21/documentation/streams/developer-guide/testing.html">Kafka-streams-test-utils</a> is a test-kit for testing stream topologies in memory without needing a Kafka cluster. Test-kit supports stateful operations and Avro serialization/deserialization via mocking of schema registry.</p>

<p>All that you need is <code class="highlighter-rouge">TopologyTestDriver</code>, which can be initialize on each test case where a topology is under test.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="nc">TopologyTestDriver</span> <span class="n">testDriver</span><span class="o">;</span>
<span class="kd">private</span> <span class="nc">MockSchemaRegistryClient</span> <span class="n">schemaRegistryClient</span><span class="o">;</span>

<span class="nd">@Before</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">schemaRegistryClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MockSchemaRegistryClient</span><span class="o">();</span>
<span class="o">}</span>

<span class="nd">@After</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">tearDown</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">testDriver</span><span class="o">).</span><span class="na">ifPresent</span><span class="o">(</span><span class="nl">TopologyTestDriver:</span><span class="o">:</span><span class="n">close</span><span class="o">);</span>
    <span class="n">testDriver</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">properties</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>I choose for testing topology with stateful operations and Avro.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// stateful</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">Topology</span> <span class="nf">topologyCountUsersWithSameName</span><span class="o">(</span>
  <span class="nc">String</span> <span class="n">sourceTopic</span><span class="o">,</span>
  <span class="nc">String</span> <span class="n">sinkTopic</span><span class="o">,</span>
  <span class="kd">final</span> <span class="nc">Serde</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">personSerdes</span><span class="o">,</span>
  <span class="kd">final</span> <span class="nc">String</span> <span class="n">storeName</span><span class="o">)</span> <span class="o">{</span>

  <span class="kd">final</span> <span class="nc">StreamsBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StreamsBuilder</span><span class="o">();</span>
  <span class="n">builder</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">sourceTopic</span><span class="o">,</span> <span class="nc">Consumed</span><span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">(),</span> <span class="n">personSerdes</span><span class="o">))</span>
      <span class="o">.</span><span class="na">groupBy</span><span class="o">((</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">value</span><span class="o">.</span><span class="na">getName</span><span class="o">())</span>
      <span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="nc">Materialized</span><span class="o">.&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">,</span> <span class="nc">KeyValueStore</span><span class="o">&lt;</span><span class="nc">Bytes</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;&gt;</span><span class="n">as</span><span class="o">(</span><span class="n">storeName</span><span class="o">))</span>
      <span class="o">.</span><span class="na">toStream</span><span class="o">()</span>
      <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="n">sinkTopic</span><span class="o">,</span> <span class="nc">Produced</span><span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="nc">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">(),</span> <span class="nc">Serdes</span><span class="o">.</span><span class="na">Long</span><span class="o">()));</span>

  <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Unit test of topology.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testTopologyAvro_statefulProcessors</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">RestClientException</span> <span class="o">{</span>
    <span class="cm">/** Arrange */</span>
    <span class="kd">final</span> <span class="nc">String</span> <span class="n">storeName</span> <span class="o">=</span> <span class="s">"same-name"</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">SpecificAvroSerde</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">serde</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SpecificAvroSerde</span><span class="o">&lt;&gt;(</span><span class="n">schemaRegistryClient</span><span class="o">);</span>
    
    <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">schema</span> <span class="o">=</span>
        <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span>
            <span class="nc">AbstractKafkaAvroSerDeConfig</span><span class="o">.</span><span class="na">SCHEMA_REGISTRY_URL_CONFIG</span><span class="o">,</span>
            <span class="s">"wat-ever-url-anyway-it-is-mocked"</span><span class="o">);</span>
    <span class="n">serde</span><span class="o">.</span><span class="na">configure</span><span class="o">(</span><span class="n">schema</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="c1">// get topology</span>
    <span class="kd">final</span> <span class="nc">Topology</span> <span class="n">topology</span> <span class="o">=</span>
        <span class="nc">StreamProcessingAvro</span><span class="o">.</span><span class="na">topologyCountUsersWithSameName</span><span class="o">(</span>
            <span class="n">topicIn</span><span class="o">,</span> 
            <span class="n">topicOut</span><span class="o">,</span> 
            <span class="n">serde</span><span class="o">,</span> 
            <span class="n">storeName</span>
        <span class="o">);</span>
    <span class="n">testDriver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TopologyTestDriver</span><span class="o">(</span><span class="n">topology</span><span class="o">,</span> <span class="n">properties</span><span class="o">);</span>
    
    <span class="kd">final</span> <span class="nc">ConsumerRecordFactory</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Person</span><span class="o">&gt;</span> <span class="n">factory</span> <span class="o">=</span>
        <span class="k">new</span> <span class="nc">ConsumerRecordFactory</span><span class="o">&lt;&gt;(</span><span class="n">topicIn</span><span class="o">,</span> <span class="k">new</span> <span class="nc">StringSerializer</span><span class="o">(),</span> <span class="n">serde</span><span class="o">.</span><span class="na">serializer</span><span class="o">());</span>
    
    <span class="kd">final</span> <span class="nc">ConsumerRecord</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[],</span> <span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">inRecord1</span> <span class="o">=</span>
        <span class="n">factory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
            <span class="n">topicIn</span><span class="o">,</span>
            <span class="s">"1"</span><span class="o">,</span>
            <span class="nc">Person</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="s">"id-1"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"nikita"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setLastname</span><span class="o">(</span><span class="s">"zhevnitskiy"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">()</span>
        <span class="o">);</span>
    
    <span class="kd">final</span> <span class="nc">ConsumerRecord</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[],</span> <span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">inRecord2</span> <span class="o">=</span>
        <span class="n">factory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
            <span class="n">topicIn</span><span class="o">,</span>
            <span class="s">"2"</span><span class="o">,</span>
            <span class="nc">Person</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="s">"id-2"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"nikita"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setLastname</span><span class="o">(</span><span class="s">"moscow"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">()</span>
        <span class="o">);</span>
    
    <span class="cm">/** Act */</span>
    <span class="n">testDriver</span><span class="o">.</span><span class="na">pipeInput</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">inRecord1</span><span class="o">,</span> <span class="n">inRecord2</span><span class="o">));</span>
    <span class="kd">final</span> <span class="nc">KeyValueStore</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">keyValueStore</span> <span class="o">=</span> <span class="n">testDriver</span><span class="o">.</span><span class="na">getKeyValueStore</span><span class="o">(</span><span class="n">storeName</span><span class="o">);</span>
    <span class="kd">final</span> <span class="nc">Long</span> <span class="n">amountOfRecordWithSameName</span> <span class="o">=</span> <span class="n">keyValueStore</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"nikita"</span><span class="o">);</span>
    
    <span class="cm">/** Assert */</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="nc">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">2</span><span class="o">),</span> <span class="n">amountOfRecordWithSameName</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>You can find full test example <a href="https://github.com/sysco-middleware/kafka-testing/blob/master/streams-client/src/test/java/no/sysco/testing/kafka/streams/topology/StreamProcessingAvroTest.java">here</a> and more examples in <a href="https://kafka.apache.org/21/documentation/streams/developer-guide/testing.html">Apache Kafka documentation</a>.</p>

<p>Pay attention to issue <a href="https://github.com/confluentinc/schema-registry/issues/877">#877 - Passing Schema Registry URL twice to instantiate KafkaAvroSerializer</a>.</p>

<h3 id="3-integration-tests-with-embeddedkafkacluster">3. Integration tests with <a href="https://github.com/apache/kafka/tree/trunk/streams/src/test/java/org/apache/kafka/streams/integration/utils">EmbeddedKafkaCluster</a></h3>
<p>Integration test is a way of how to test services in isolation but with required dependencies. 
Embedded Kafka cluster combines broker, zookeeper and schema-registry in one. 
To test asynchronous system I have chosen <a href="http://www.awaitility.org">awaitility library</a>. 
It is a useful tool for handling timeouts and asynchronous  asserts.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApplicationIT</span> <span class="o">{</span>
  <span class="nd">@ClassRule</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">EmbeddedSingleNodeKafkaCluster</span> <span class="no">CLUSTER</span> <span class="o">=</span> 
    <span class="k">new</span> <span class="nf">EmbeddedSingleNodeKafkaCluster</span><span class="o">();</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clusterIsRunning</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">assertTrue</span><span class="o">(</span><span class="no">CLUSTER</span><span class="o">.</span><span class="na">isRunning</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAvroConsumer</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span><span class="o">,</span> 
    <span class="nc">ExecutionException</span><span class="o">,</span> <span class="nc">TimeoutException</span> <span class="o">{</span>

    <span class="nc">String</span> <span class="n">topic</span> <span class="o">=</span> <span class="s">"topic2"</span><span class="o">;</span>
    <span class="no">CLUSTER</span><span class="o">.</span><span class="na">createTopic</span><span class="o">(</span><span class="n">topic</span><span class="o">);</span>

    <span class="kd">final</span> <span class="nc">KafkaProducer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Event</span><span class="o">&gt;</span> <span class="n">producer</span> <span class="o">=</span> 
      <span class="k">new</span> <span class="nc">KafkaProducer</span><span class="o">&lt;&gt;(</span><span class="n">getProducerProperties</span><span class="o">());</span>
    
    <span class="n">producer</span>
      <span class="o">.</span><span class="na">send</span><span class="o">(</span>
        <span class="k">new</span> <span class="nc">ProducerRecord</span><span class="o">&lt;&gt;(</span>
          <span class="n">topic</span><span class="o">,</span>
          <span class="s">"id-3"</span><span class="o">,</span>
          <span class="nc">Event</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
          <span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="s">"id-3"</span><span class="o">)</span>
          <span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="s">"type-3"</span><span class="o">)</span>
          <span class="o">.</span><span class="na">setContext</span><span class="o">(</span><span class="s">"context-3"</span><span class="o">)</span>
          <span class="o">.</span><span class="na">build</span><span class="o">()))</span>
      <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>

    <span class="kd">final</span> <span class="nc">KafkaConsumer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Event</span><span class="o">&gt;</span> <span class="n">consumer</span> <span class="o">=</span> 
      <span class="k">new</span> <span class="nc">KafkaConsumer</span><span class="o">&lt;&gt;(</span><span class="n">getConsumerProperties</span><span class="o">());</span>
    <span class="n">consumer</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">topic</span><span class="o">));</span>

    <span class="kd">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Event</span><span class="o">&gt;</span> <span class="n">events</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="n">await</span><span class="o">()</span>
      <span class="o">.</span><span class="na">atMost</span><span class="o">(</span><span class="mi">15</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
      <span class="o">.</span><span class="na">untilAsserted</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="kd">final</span> <span class="nc">ConsumerRecords</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Event</span><span class="o">&gt;</span> <span class="n">records</span> <span class="o">=</span> 
            <span class="n">consumer</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
          <span class="k">for</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">ConsumerRecord</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Event</span><span class="o">&gt;</span> <span class="n">record</span> <span class="o">:</span> <span class="n">records</span><span class="o">)</span> 
            <span class="n">events</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">record</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
  
          <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">events</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
      <span class="o">});</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="4-end-to-end-tests-with-testcontainers">4. End-to-end tests with <a href="https://www.testcontainers.org">Testcontainers</a></h3>
<p>In context of Kafka-based applications, end-to-end testing will be applied to  data pipelines to ensure that, first, the data integrity is maintained between applications and, second, data pipelines behave as expected. 
Testing requires all integrated components of application to be up and running - in order to be able to test them with different scenarios.
<img src="/images/2019-06-24-testing-kafka-based-applications/data_pipeline.png" alt="data pipeline" /></p>

<p>Requirements:</p>
<ul>
  <li>Zookeeper </li>
  <li>Kafka broker </li>
  <li>Confluent schema registry </li>
  <li>Http-producer: REST producer </li>
  <li>Http-materializer: streams application, that downstreams topic data and RPC to another REST service</li>
  <li>Db-mock: REST service and db in memory (use .json file as persistent storage), all-in-one</li>
</ul>

<p>I describe two approaches on how to prepare a container environment for testing. Both of them require a certain start-up sequence, namely: start a Kafka cluster first, wait until it is ready to receive requests, create required topics, register schemas and then run application services.</p>

<h4 id="approach-1-declare-each-container-separately">Approach 1: Declare each container separately</h4>
<p>Each container is defined in the same test class under its own method and is run either <code class="highlighter-rouge">@BeforeClass</code> or in a <code class="highlighter-rouge">static</code> block. 
Be aware about differences mentioned in <a href="https://www.testcontainers.org/test_framework_integration/manual_lifecycle_control/#singleton-containers">documentation</a>.</p>

<p>Testcontainers support <code class="highlighter-rouge">Waiting strategies</code> until containers are ready for test. Potential improvement could be implementation of health checks for each component in data pipeline.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Base test  abstract class contains setup to
 * initialize testing environment.
 */</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ContainersTestBaseIT</span> <span class="o">{</span>

    <span class="c1">// singleton containers https://www.testcontainers.org/test_framework_integration/manual_lifecycle_control/#singleton-containers</span>
    <span class="kd">static</span>  <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Network</span> <span class="n">commonNetwork</span> <span class="o">=</span> <span class="nc">Network</span><span class="o">.</span><span class="na">newNetwork</span><span class="o">();</span>
        <span class="n">setZookeeperAndKafka</span><span class="o">(</span><span class="n">commonNetwork</span><span class="o">);</span>
        <span class="n">setSchemaRegistry</span><span class="o">(</span><span class="n">commonNetwork</span><span class="o">);</span>
        <span class="n">setJsonServer</span><span class="o">(</span><span class="n">commonNetwork</span><span class="o">);</span>
        <span class="n">setHttProducer</span><span class="o">(</span><span class="n">commonNetwork</span><span class="o">);</span>
        <span class="n">setHttpMaterializer</span><span class="o">(</span><span class="n">commonNetwork</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="c1">// . . . rest code</span>
<span class="o">}</span>
</code></pre></div></div>

<p>To make containers interact with each other, you should put them with the same network. 
If one container depends on another container, you might need network alias to setup communication between them. 
You can provide your own network alias for container or use an already existing one. 
Aliases can be injected as environmental variable.</p>

<p>Container ports can be mapped to <code class="highlighter-rouge">localhost</code> while testing, if container’s port is exposed. 
Files and directories can be also mapped as volumes on the classpath in container.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">jsonServer</span> <span class="o">=</span>
  <span class="k">new</span> <span class="nf">GenericContainer</span><span class="o">(</span><span class="s">"zhenik/json-server"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">withExposedPorts</span><span class="o">(</span><span class="mi">80</span><span class="o">)</span>
    <span class="c1">// all containers put in same network</span>
    <span class="o">.</span><span class="na">withNetwork</span><span class="o">(</span><span class="n">network</span><span class="o">)</span> 
    <span class="o">.</span><span class="na">withEnv</span><span class="o">(</span><span class="s">"ID_MAP"</span><span class="o">,</span> <span class="s">"id"</span><span class="o">)</span>
    <span class="c1">// all containers put in same network</span>
    <span class="o">.</span><span class="na">withNetworkAliases</span><span class="o">(</span><span class="s">"json-server"</span><span class="o">)</span> 
    <span class="c1">// mount volume</span>
    <span class="o">.</span><span class="na">withClasspathResourceMapping</span><span class="o">(</span>
            <span class="s">"json-server-database.json"</span><span class="o">,</span> <span class="s">"/data/db.json"</span><span class="o">,</span> <span class="nc">BindMode</span><span class="o">.</span><span class="na">READ_WRITE</span><span class="o">)</span>
    <span class="c1">// waiting strategy</span>
    <span class="o">.</span><span class="na">waitingFor</span><span class="o">(</span><span class="nc">Wait</span><span class="o">.</span><span class="na">forHttp</span><span class="o">(</span><span class="s">"/"</span><span class="o">).</span><span class="na">forStatusCode</span><span class="o">(</span><span class="mi">200</span><span class="o">));</span>

<span class="n">jsonServer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
<span class="c1">// exposed to localhost</span>
<span class="no">JSON_SERVER_EXPOSED</span> <span class="o">=</span> 
  <span class="s">"http://"</span><span class="o">+</span><span class="n">jsonServer</span><span class="o">.</span><span class="na">getContainerIpAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">jsonServer</span><span class="o">.</span><span class="na">getMappedPort</span><span class="o">(</span><span class="mi">80</span><span class="o">);</span>
<span class="c1">// exposed to network with all containers</span>
<span class="no">JSON_SERVER_INSIDE_DOCKER_ENV</span> <span class="o">=</span> <span class="s">"http://"</span> <span class="o">+</span> <span class="n">jsonServer</span><span class="o">.</span><span class="na">getNetworkAliases</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">+</span> <span class="s">":80"</span><span class="o">;</span>
</code></pre></div></div>

<p>Another useful feature is executing commands inside a container. 
It can be useful for creating a kafka topic before running streams application.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">createTopic</span><span class="o">(</span><span class="nc">String</span> <span class="n">topicName</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// kafka container uses with embedded zookeeper</span>
    <span class="c1">// confluent platform and Kafka compatibility 5.1.x &lt;-&gt; kafka 2.1.x</span>
    <span class="c1">// kafka 2.1.x require option --zookeeper, later versions use --bootstrap-servers instead</span>
    <span class="nc">String</span> <span class="n">createTopic</span> <span class="o">=</span>
        <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
            <span class="s">"/usr/bin/kafka-topics --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic %s"</span><span class="o">,</span>
            <span class="n">topicName</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="kd">final</span> <span class="nc">Container</span><span class="o">.</span><span class="na">ExecResult</span> <span class="n">execResult</span> <span class="o">=</span> <span class="n">kafka</span><span class="o">.</span><span class="na">execInContainer</span><span class="o">(</span><span class="s">"/bin/sh"</span><span class="o">,</span> <span class="s">"-c"</span><span class="o">,</span> <span class="n">createTopic</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">execResult</span><span class="o">.</span><span class="na">getExitCode</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="n">fail</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="n">fail</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="approach-2-define-containers-in-docker-compose-file">Approach 2: Define containers in docker-compose file</h4>
<p>Another approach is to prepare containers environment for testing is to define all the environment information in a docker-compose.yml. In this case Testcontainers manage composition of containers. All services share common network. Name of service uses as a network alias. This approach also supports waiting strategies. 
Example of how to create topic in a <code class="highlighter-rouge">docker-compose</code> file can be found in <a href="https://github.com/confluentinc/examples/blob/f854ac008952346ceaba0d1f1a352788f0572c74/microservices-orders/docker-compose.yml#L182-L215">Confluent examples</a>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Environment container contains composition of containers which are declared
 * in docker-compose.test.yml file. Use a local Docker Compose binary.
 * Waiting strategies are applied to `service-name` with suffix `_1`
 */</span>
  <span class="nd">@ClassRule</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">DockerComposeContainer</span> <span class="n">environment</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nf">DockerComposeContainer</span><span class="o">(</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"docker-compose.test.yml"</span><span class="o">))</span>
        <span class="o">.</span><span class="na">withLocalCompose</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">waitingFor</span><span class="o">(</span><span class="s">"db-mock_1"</span><span class="o">,</span> <span class="nc">Wait</span><span class="o">.</span><span class="na">forHttp</span><span class="o">(</span><span class="s">"/"</span><span class="o">).</span><span class="na">forStatusCode</span><span class="o">(</span><span class="mi">200</span><span class="o">))</span>
        <span class="o">.</span><span class="na">waitingFor</span><span class="o">(</span><span class="s">"schema-registry_1"</span><span class="o">,</span> <span class="nc">Wait</span><span class="o">.</span><span class="na">forHttp</span><span class="o">(</span><span class="s">"/subjects"</span><span class="o">).</span><span class="na">forStatusCode</span><span class="o">(</span><span class="mi">200</span><span class="o">))</span>
        <span class="o">.</span><span class="na">waitingFor</span><span class="o">(</span><span class="s">"http-producer_1"</span><span class="o">,</span> <span class="nc">Wait</span><span class="o">.</span><span class="na">forHttp</span><span class="o">(</span><span class="s">"/messages"</span><span class="o">).</span><span class="na">forStatusCode</span><span class="o">(</span><span class="mi">200</span><span class="o">))</span>
        <span class="o">.</span><span class="na">withExposedService</span><span class="o">(</span><span class="s">"db-mock_1"</span><span class="o">,</span> <span class="mi">80</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withExposedService</span><span class="o">(</span><span class="s">"http-producer_1"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">);</span>
</code></pre></div></div>

<p>Test</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test_data_pipeline_flow_successful</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">id</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">from</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">to</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">text</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>

    <span class="nc">MessageJsonRepresentation</span> <span class="n">messageJsonRepresentation</span> <span class="o">=</span>
        <span class="k">new</span> <span class="nf">MessageJsonRepresentation</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">from</span><span class="o">,</span> <span class="n">to</span><span class="o">,</span> <span class="n">text</span><span class="o">);</span>

    <span class="nc">RestAssured</span><span class="o">.</span><span class="na">given</span><span class="o">()</span>
        <span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="nc">ContentType</span><span class="o">.</span><span class="na">JSON</span><span class="o">)</span>
        <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">messageJsonRepresentation</span><span class="o">)</span>
        <span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="no">HTTP_PRODUCER_EXPOSED</span> <span class="o">+</span> <span class="s">"/messages"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">then</span><span class="o">()</span>
        <span class="o">.</span><span class="na">statusCode</span><span class="o">(</span><span class="mi">202</span><span class="o">);</span>

    <span class="n">await</span><span class="o">()</span>
        <span class="o">.</span><span class="na">atMost</span><span class="o">(</span><span class="mi">70</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
        <span class="o">.</span><span class="na">untilAsserted</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">MessageJsonRepresentation</span> <span class="n">jsonPresentation</span> <span class="o">=</span>
                <span class="nc">RestAssured</span><span class="o">.</span><span class="na">given</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="no">JSON_SERVER_EXPOSED</span> <span class="o">+</span> <span class="s">"/messages/"</span> <span class="o">+</span> <span class="n">id</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">then</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">extract</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">as</span><span class="o">(</span><span class="nc">MessageJsonRepresentation</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

            <span class="n">assertNotNull</span><span class="o">(</span><span class="n">jsonPresentation</span><span class="o">);</span>
        <span class="o">});</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="conclusion">Conclusion</h3>
<p>Hopefully, the described approaches and code examples will help to make testing Kafka client application easier. If you would like to contribute, just open a ticket on GitHub for ideas. 
Additionally, I would recommend to check <a href="https://www.confluent.io/blog/">Confluent’s blog</a> that can be helpful to learn more about Apache Kafka.</p>

<p><a href="https://github.com/sysco-middleware/kafka-testing">Github repository</a></p>

<p>Thanks to <a href="https://github.com/jeqo">Jorge Quilcate</a>, <a href="https://github.com/bsideup">Sergei Egorov</a>, <a href="https://github.com/timurgen">Timur Samkharadze</a>, <a href="https://github.com/daria-taria">Dasha Kormacheva</a>.</p>

:ET